@let myUserObj = myUser();
@let pendingAudiobooks = pendingPaymentAudioboks();
@let selected = selectedAudiobook();

<div class="container">
    @if (!myUserObj) {
        <div class="col-12 col-md-7 col-lg-7 mx-auto px-3 px-md-0">
            <app-mobile-header></app-mobile-header>
            <div class="p-3">
                <h3>Nice to see you here, author</h3>
                <div class="mt-3">
                    You need to be logged in to continue.
                </div>
            </div>
            <app-mobile-footer></app-mobile-footer>
        </div>
    } @else {
        <div class="col-12 col-md-7 col-lg-7 mx-auto px-3 px-md-0 pb-5">
            <div class="etmw-bg-lighter rounded-bottom-xl px-4 pt-3 pb-4 sticky-top" style="top: 0; z-index: 100;">
                <div class="d-flex justify-content-between align-items-center gap-3">
                    <button class="btn btn-link text-white p-0" (click)="goBack()">
                        <i class="bi bi-chevron-left" style="font-size: 1.5rem;"></i>
                    </button>
                    <h3 class="fw-bold m-0 flex-grow-1 text-center">
                        Resume Pending Payment
                    </h3>
                    <div style="width: 32px;"></div>
                </div>
            </div>

            <div class="px-4 pt-4">
                @if (!selected) {
                    @if (pendingAudiobooks.length === 0) {
                        <div class="bg-secondary rounded-4 p-4 text-center">
                            <div class="mb-2" style="font-size: 2rem;">✅</div>
                            <h5 class="fw-bold mb-2">No pending payments</h5>
                            <div class="text-gray-400 small">
                                You don’t have pending audiobook payments right now.
                            </div>
                        </div>
                    } @else {
                        <div class="small text-gray-400 mb-3">
                            Select an audiobook to continue with payment.
                        </div>
                        <div class="d-flex flex-column gap-4">
                            @for (audiobook of pendingAudiobooks; track audiobook._id) {
                                <div class="bg-secondary rounded-4 p-3">
                                    <app-item [audiobook]="audiobook" template="default"></app-item>
                                    <div class="d-flex justify-content-center flex-wrap gap-2 mt-3">
                                        <button class="btn btn-outline-secondary rounded-pill px-4" (click)="archiveAudiobook(audiobook._id)">
                                            Archive
                                        </button>
                                        <button class="btn btn-primary rounded-pill px-4" (click)="selectAudiobook(audiobook)">
                                            Resume Payment
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                } @else {
                    <div class="mt-2 fade-in-up">
                        <div class="d-flex justify-content-between align-items-center gap-2 mb-4">
                            <h3 class="fw-bold m-0">Review Payment</h3>
                            <button class="btn btn-secondary rounded-pill px-4" (click)="backToList()">
                                <i class="bi bi-arrow-left"></i> Back to list
                            </button>
                        </div>

                        <div class="bg-secondary rounded-4 p-4 mb-3">
                            <h3 class="fw-semibold mb-3">Upload Method</h3>
                            @if (selected.uploadMethod === 'digital') {
                                <div class="d-flex align-items-center gap-3">
                                    <i class="bi bi-cloud-upload-fill text-primary" style="font-size: 2rem;"></i>
                                    <div>
                                        <div class="fw-semibold">{{ getUploadMethodLabel(selected.uploadMethod) }}</div>
                                        <div class="small text-gray-400">{{ getUploadFileLabel(selected) }}</div>
                                    </div>
                                </div>
                            } @else {
                                <div class="d-flex align-items-center gap-3">
                                    <i class="bi bi-mailbox text-primary" style="font-size: 2rem;"></i>
                                    <div>
                                        <div class="fw-semibold">{{ getUploadMethodLabel(selected.uploadMethod) }}</div>
                                        <div class="small text-gray-400">Please send to the provided address</div>
                                    </div>
                                </div>
                            }
                        </div>

                        <div class="bg-secondary rounded-4 p-4 mb-3">
                            <h3 class="fw-semibold mb-3">Cover Image</h3>
                            @if (selected.coverFile) {
                                <div class="d-flex align-items-center gap-3">
                                    <i class="bi bi-image-fill text-primary" style="font-size: 2rem;"></i>
                                    <div class="fw-semibold">Cover uploaded</div>
                                </div>
                            } @else {
                                <div class="small text-gray-400">No cover selected</div>
                            }
                        </div>

                        <div class="bg-secondary rounded-4 p-4 mb-3">
                            <h3 class="fw-semibold mb-3">Book Details</h3>
                            <div class="row g-3">
                                <div class="col-6">
                                    <div class="small text-gray-400">Title</div>
                                    <div class="fw-semibold">{{ selected.title || 'N/A' }}</div>
                                </div>
                                <div class="col-6">
                                    <div class="small text-gray-400">Author</div>
                                    <div class="fw-semibold">{{ selected.authorName || 'N/A' }}</div>
                                </div>
                                <div class="col-12">
                                    <div class="small text-gray-400">Categories</div>
                                    <div class="d-flex flex-wrap gap-2 mt-1">
                                        @if (selected.categories && selected.categories.length > 0) {
                                            @for (cat of selected.categories; track cat) {
                                                <span class="bg-primary px-3 py-1 rounded-3">{{ cat }}</span>
                                            }
                                        } @else {
                                            <span class="small text-gray-400">No categories</span>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-secondary rounded-4 p-4 mb-3">
                            <h3 class="fw-semibold mb-3">Voice Configuration</h3>
                            <div class="row g-3">
                                <div class="col-6">
                                    <div class="small text-gray-400">Language</div>
                                    <div class="fw-semibold">{{ getLanguageName(selected.sourceLanguage) }}</div>
                                </div>
                                <div class="col-6">
                                    <div class="small text-gray-400">Voice</div>
                                    <div class="fw-semibold">{{ selected.voiceName || 'N/A' }}</div>
                                </div>
                                <div class="col-12">
                                    <div class="d-flex flex-wrap gap-2">
                                        @if (selected.useExpression) {
                                            <span class="bg-slate-800 px-3 py-1 rounded-3">
                                                <i class="bi bi-emoji-smile"></i> Expression Enabled
                                            </span>
                                        }
                                        @if (selected.targetLanguage && selected.targetLanguage !== selected.sourceLanguage) {
                                            <span class="bg-slate-800 px-3 py-1 rounded-3">
                                                <i class="bi bi-translate"></i> Translating to {{ getLanguageName(selected.targetLanguage) }}
                                            </span>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-slate-800 rounded-4 p-4 mb-4 text-center border border-2"
                             [class.border-success]="selected.hasReferral"
                             [class.border-primary]="!selected.hasReferral">
                            <h3 class="fw-bold mb-2">Total Cost</h3>
                            @if (selected.hasReferral && selected.totalPrice === 0) {
                                <div class="text-success" style="font-size: 3rem; font-weight: 700;">FREE</div>
                                <div class="small text-gray-400">Referral code applied</div>
                            } @else if (selected.hasReferral && selected.totalPrice > 0) {
                                <div class="text-warning" style="font-size: 3rem; font-weight: 700;">{{ getTotalPriceLabel(selected) }}</div>
                                <div class="small text-gray-400">
                                    <div class="text-success mb-1">Base price: FREE (Referral applied)</div>
                                    <div>Premium features: {{ getTotalPriceLabel(selected) }}</div>
                                </div>
                            } @else {
                                <div class="text-primary" style="font-size: 3rem; font-weight: 700;">{{ getTotalPriceLabel(selected) }}</div>
                                <div class="small text-gray-400">One-time payment</div>
                            }
                        </div>

                        <div class="bg-secondary rounded-4 p-4 mb-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="termsCheckResume" [(ngModel)]="acceptedTerms">
                                <label class="form-check-label" for="termsCheckResume">
                                    I have read and agree to the Terms & Conditions
                                </label>
                            </div>
                        </div>

                        <button class="btn btn-primary btn-lg rounded-pill px-5 w-100"
                                [disabled]="!acceptedTerms || working()"
                                (click)="resumePaymentSelected()">
                            @if (!working()) {
                                <span><i class="bi bi-credit-card"></i> Continue to Payment</span>
                            } @else {
                                <span class="d-inline-flex align-items-center gap-2">
                                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                    Redirecting...
                                </span>
                            }
                        </button>
                    </div>
                }
            </div>
        </div>
    }
</div>
