<div class="container">
    
    <div class="col-12 col-md-7 col-lg-7 mx-auto px-3 px-md-0">

        <!--
            HEADER WITH TABS
        -->
        <div class="etmw-bg-lighter rounded-bottom-xl px-4 pt-3 pb-3 sticky-top" style="top: 0; z-index: 100;">
            <div class="d-flex justify-content-between align-items-center gap-3 mb-3">
                <h3 class="fw-bold m-0">
                    ðŸ’¬ &nbsp; Messages
                </h3>
                <div class="d-flex gap-2">
                    <button class="btn btn-secondary rounded-pill px-3">
                        <i class="bi bi-search"></i>
                    </button>
                    <button class="btn btn-dark rounded-pill" (click)="goHome()">
                        <i class="bi bi-house-door-fill"></i>
                    </button>
                </div>
            </div>
    
            <!-- Filter Tabs -->
            <div class="d-flex gap-2 overflow-x-auto pb-2" style="white-space: nowrap;">
                <button
                    class="btn btn-sm rounded-pill px-3"
                    [class.btn-primary]="activeFilter() === 'all'"
                    [class.btn-secondary]="activeFilter() !== 'all'"
                    (click)="setFilter('all')"
                >
                    <i class="bi bi-inbox-fill"></i> All ({{ channels().length }})
                </button>
                <button
                    class="btn btn-sm rounded-pill px-3"
                    [class.btn-primary]="activeFilter() === 'unread'"
                    [class.btn-secondary]="activeFilter() !== 'unread'"
                    (click)="setFilter('unread')"
                >
                    <i class="bi bi-circle-fill text-danger" style="font-size: 0.5rem;"></i> Unread ({{ getUnreadConversationsCount() }})
                </button>
                <button class="btn btn-sm btn-secondary rounded-pill px-3">
                    <i class="bi bi-star-fill"></i> Important
                </button>
                <button class="btn btn-sm btn-secondary rounded-pill px-3">
                    <i class="bi bi-archive-fill"></i> Archived
                </button>
            </div>
        </div>
    
        <!--
            AI SUMMARY CARD
        -->
        <div class="mx-4 mt-4">
            <div class="bg-slate-800 rounded-4 p-4 border border-2" style="border-color: var(--color-primary) !important; background: linear-gradient(135deg, rgba(37, 99, 235, 0.1) 0%, rgba(37, 99, 235, 0.05) 100%);">
                <div class="d-flex align-items-start gap-3">
                    <div class="rounded-3 p-2 flex-shrink-0" style="background: linear-gradient(135deg, var(--color-primary) 0%, #1d4ed8 100%); width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;">
                        <i class="bi bi-stars" style="font-size: 1.25rem;"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <div class="fw-bold">AI Summary</div>
                                <div class="small">{{ getUnreadConversationsCount() }} unread conversations</div>
                            </div>
                        </div>
                        <div class="text-light lh-175 small">
                            Maria sent you a first message about collaboration opportunities. 
                            Tony is asking about your book "Away" and wants a signed copy. 
                            Romain responded to your question about pricing.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
        <!--
            QUICK ACTIONS
        -->
        <div class="mx-4 mt-3">
            <div class="d-flex justify-content-center align-items-center gap-2 pb-2">
                <button class="btn btn-secondary rounded-pill px-3 flex-shrink-0" (click)="gotoNewMessage()">
                    <i class="bi bi-pencil-square"></i> New Message
                </button>
                <button class="btn btn-secondary rounded-pill px-3 flex-shrink-0" (click)="markAllRead()">
                    <i class="bi bi-check-all"></i> Mark All Read
                </button>
                <!-- <button class="btn btn-secondary rounded-pill px-3 flex-shrink-0">
                    <i class="bi bi-funnel"></i> Filter
                </button> -->
            </div>
        </div>
    
        <!--
            LIST OF MESSAGES
        -->
        <div class="mt-4 mx-4 pb-5">
            @if (loading()) {
                <div class="text-center py-4 text-gray-400">Loading messages...</div>
            }
    
            @for (item of getVisibleChannels(); track item._id) {
                <div class="bg-secondary rounded-4 mb-3 pointer position-relative overflow-hidden" 
                     [class.border]="item.unreadCount > 0"
                     [class.border-primary]="item.unreadCount > 0"
                     style="transition: all 0.2s ease;"
                     (click)="openChannel(item)">
                    
                    <!-- Unread indicator bar -->
                    @if (item.unreadCount > 0) {
                        <div class="position-absolute start-0 top-0 bottom-0" 
                             style="width: 4px; background: linear-gradient(180deg, var(--color-primary) 0%, #1d4ed8 100%);"></div>
                    }
    
                    <div class="d-flex justify-content-between align-items-center gap-3 p-3">
                        <!-- Avatar with online status -->
                        <div class="position-relative flex-shrink-0">
                            <div class="rounded-circle overflow-hidden border border-2" 
                                 [class.border-primary]="item.unreadCount > 0"
                                 style="width: 60px; height: 60px;">
                                <img [src]="item.userProfile" class="w-100 h-100" style="object-fit: cover;" />
                            </div>
                            <!-- Online indicator -->
                            @if (item.isOnline) {
                                <div class="position-absolute" 
                                     style="bottom: 2px; right: 2px; width: 16px; height: 16px; background-color: #22c55e; border-radius: 50%; border: 3px solid var(--color-secondary);"></div>
                            }
                        </div>
    
                        <!-- Message content -->
                        <div class="flex-grow-1 min-w-0">
                            <div class="d-flex justify-content-between align-items-start mb-1">
                                <div class="fw-bold" [class.text-primary]="item.unreadCount > 0">
                                    {{ item.userName }}
                                    @if (item.isVerified) {
                                        <i class="bi bi-patch-check-fill text-primary ms-1" style="font-size: 0.875rem;"></i>
                                    }
                                </div>
                                <div class="small text-gray-400 flex-shrink-0 ms-2">
                                    {{ item.lastMessageTime }}
                                </div>
                            </div>
                            <div class="small text-gray-400 text-truncate" 
                                 [class.text-white]="item.unreadCount > 0"
                                 [class.fw-semibold]="item.unreadCount > 0">
                                @if (item.lastMessageType === 'voice') {
                                    <i class="bi bi-mic-fill text-primary"></i>
                                } @else if (item.lastMessageType === 'image') {
                                    <i class="bi bi-image-fill text-primary"></i>
                                }
                                {{ item.lastMessage }}
                            </div>
                        </div>
    
                        <!-- Actions and unread badge -->
                        <div class="d-flex flex-column align-items-end gap-2 flex-shrink-0">
                            @if (item.unreadCount > 0) {
                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center fw-bold" 
                                     style="min-width: 28px; height: 28px; font-size: 0.75rem; padding: 0 8px;">
                                    {{ item.unreadCount }}
                                </div>
                            }                            
                        </div>
                    </div>
                    <div class="p-3">
                        <div class="d-flex justify-content-end align-items-center gap-2" >
                            <button class="btn btn-sm btn-outline-danger rounded-pill" (click)="deleteThread(item, $event)"><i class="bi bi-trash"></i> Delete</button>
                            <button class="btn btn-sm btn-secondary rounded-pill" (click)="toggleStar(item, $event)"><i class="bi bi-star"></i></button>
                            <button class="btn btn-sm btn-secondary rounded-pill" (click)="archiveThread(item, $event)"><i class="bi bi-archive"></i></button>
                            <button class="btn btn-sm btn-secondary rounded-pill" (click)="markThreadAsRead(item, $event)">
                                <i class="bi bi-check-all"></i> Mark as Read
                            </button>
                        </div>

                    </div>

                </div>
            }
    
            <!-- Empty state -->
            @if (!loading() && getVisibleChannels().length === 0) {
                <div class="text-center py-5">
                    <div class="mb-3" style="font-size: 4rem; opacity: 0.3;">
                        ðŸ“­
                    </div>
                    @if (activeFilter() === 'unread') {
                        <h5 class="text-gray-400">No unread messages</h5>
                        <p class="text-gray-400 small">You are all caught up.</p>
                    } @else {
                        <h5 class="text-gray-400">No messages yet</h5>
                        <p class="text-gray-400 small">Start a conversation with someone!</p>
                        <button class="btn btn-primary rounded-pill px-4 mt-3" (click)="gotoNewMessage()">
                            <i class="bi bi-pencil-square"></i> New Message
                        </button>
                    }
                </div>
            }
    
            <!-- Load more -->
            @if (channels().length > 0 && hasMore) {
                <div class="text-center mt-4">
                    <button class="btn px-5 py-3 btn-secondary rounded-pill" (click)="loadMore()">
                        <i class="bi bi-arrow-down-circle"></i> Load More
                    </button>
                </div>
            }
    
        </div>
    </div>

</div>

<!-- Floating new message button (mobile) -->
<button class="btn btn-primary rounded-circle position-fixed d-md-none shadow-lg" 
        (click)="gotoNewMessage()"
        style="bottom: 80px; right: 20px; width: 56px; height: 56px; z-index: 1000;">
    <i class="bi bi-pencil-fill" style="font-size: 1.25rem;"></i>
</button>
