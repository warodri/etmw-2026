<div class="container-fluid">
    
    <div class="col-12 col-md-7 col-lg-7 mx-auto px-3 px-md-0">
        
        <app-mobile-header></app-mobile-header>

        <div class="stories-feed">
            @for (story of stories(); track story._id) {
                <div class="story-card" #storyItem [attr.data-story-id]="story._id"
                    (touchstart)="onTouchStart($event, story._id)"
                    (touchmove)="onTouchMove($event, story._id)"
                    (touchend)="onTouchEnd($event, story._id)">
                    
                    <div class="story-slider"
                         [style.width.%]="slideCount(story) * 100"
                         [style.transform]="'translateX(' + (-story.slideIndex * 100) + '%)'">
                        <!-- Slide 1: Image + quote -->
                        <div class="story-slide">
                            <img class="story-image" [src]="story.image" [alt]="story.author">
                            <div class="story-overlay" style="max-width: 50%;">
                                <div class="story-title">{{ story.title }}</div>
                                <div class="story-subtitle">{{ story.subtitle }}</div>
                                <div class="story-language">{{ languageLabel(story.language) }}</div>
                                <div class="story-quote">{{ story.quote }}</div>
                                <div class="story-actions">
                                    <button class="btn btn-sm btn-light rounded-pill">‚ù§Ô∏è Like</button>
                                    <button class="btn btn-sm btn-light rounded-pill">üí¨ Discuss</button>
                                    <button class="btn btn-sm btn-light rounded-pill" (click)="showMore(story._id)">See More</button>
                                </div>
                            </div>
                        </div>
                        
                        @for (piece of displayPieces(story); track $index) {
                            @if (!piece.audioUrl) {
                                <div class="story-slide">
                                    @if (story.chapterNumber == story.totalChapters) {
                                        <img class="story-image" src="the-end.png" alt="The End!" style="max-width: 30%;">
                                    } @else {
                                        <img class="story-image" src="more-chapters-to-come.png" alt="More chapters to come!" style="max-width: 30%;">
                                        <div class="story-overlay text-center" style="max-width: 26%; top:75%">
                                            <h1 class="fw-bold text-primary">{{ piece.title }}</h1>
                                            <h3>{{ piece.quote }}</h3>
                                            <h3>{{ piece.readingText }}</h3>
                                        </div>
                                    }
                                </div>
                            } @else {
                                <div class="story-slide">
                                    <img class="story-image" [src]="piece.audioImage" [alt]="story.author">
                                    <button class="story-audio-fab" (click)="toggleMute(story._id, $index)">
                                        <i class="bi" [class.bi-volume-up]="!piece.isMuted" [class.bi-volume-mute]="piece.isMuted"></i>
                                    </button>
                                    <div class="story-overlay story-overlay-compact" style="max-width: 26%;">
                                        <div class="mb-3 story-audio-bar">
                                            <button class="btn btn-sm btn-light rounded-circle" (click)="toggleAudio(story._id, $index)">
                                                <i class="bi" [class.bi-play-fill]="!piece.isPlaying" [class.bi-pause-fill]="piece.isPlaying"></i>
                                            </button>
                                            <div class="story-audio-progress">
                                                <div class="story-audio-progress-fill" [style.width.%]="piece.progress"></div>
                                            </div>
                                        </div>    
                                        <div class="story-title">{{ piece.title }}</div>
                                        <div class="story-subtitle">{{ story.title }}</div>
                                        <div class="story-language">{{ languageLabel(story.language) }}</div>
                                        <div class="story-quote">{{ piece.quote }}</div>
                                        <div class="story-body story-body-scroll"
                                             [class.expanded]="piece.expanded"
                                             (click)="toggleExpand(story._id, $index)">
                                            {{ piece.readingText }}
                                        </div>
                                        <div class="story-actions">
                                            <button class="btn btn-sm btn-light rounded-pill">‚ù§Ô∏è Like</button>
                                            <button class="btn btn-sm btn-light rounded-pill">üí¨ Discuss</button>
                                            @if (piece.hasResume) {
                                                <button class="btn btn-sm btn-primary rounded-pill" (click)="continueStory(story._id, $index)">
                                                    Continue
                                                </button>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </div>

                    <div class="story-indicators">
                        @for (dot of slideDots(story); track dot) {
                            <div class="dot" [class.active]="story.slideIndex === dot"></div>
                        }
                    </div>
                </div>
            }
        </div>

    </div>
</div>

<app-mobile-footer></app-mobile-footer>
